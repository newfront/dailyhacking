<html>
  <head>
  <meta charset="utf-8">
  <title>html5 mario</title>
  <link rel="stylesheet" type="text/css" href="css/mario.css"/>
  
  </head>
  <body>
    <p>Mario</p>
    <canvas id="mario_game" width="0" height="0"></canvas>
  </body>
  <script type="text/javascript">
    var game_config = {
      width: 800,
      height: 288,
      fps: 30,
      stage: {
        height: 18,
        width: 244,
        visible_width: 16,
        visible_height: 16
      },
      magnifier : 16
    }
    
    /*
      
    */
    window.environment_db = {
      elements:
      {
        /*
          Blocks are the basic building blocks in Mario. This is what you walk on (mostly), 
        */
        block: 
        {
          /*
            You walk on these
          */
          "ground_brown":{
            "img":"assets/environment/blocks/GroundBlockBrown.png",
            "width":16,
            "height":16
          },
          /*
            You jump up and break these
          */
          "brick_brown":{
            "img":"assets/environment/blocks/BrickBlockBrown.png",
            "width":16,
            "height":16
          },
          "brick_castle":{
            "img":"assets/environment/blocks/BrickBlockCastle.png",
            "width":16,
            "height":16
          },
          "brick_dark":{
            "img":"assets/environment/blocks/BrickBlockDark.png",
            "width":16,
            "height":16
          },
          "empty":{
            "img":"assets/environment/blocks/EmptyBlock.png",
            "width":16,
            "height":16
          },
          "empty_castle":{
            "img":"assets/environment/blocks/EmptyBlock.png",
            "width":16,
            "height":16
          },
          "empty_dark":{
            "img":"assets/environment/blocks/EmptyDark.png",
            "width":16,
            "height":16
          },
          /*
            You jump and connect with these to reveal coins or powerups
          */
          "question":{
            "img":"assets/environment/blocks/QuestionBlock.gif",
            "width":16,
            "height":16
          },
          "question_castle":{
            "img":"assets/environment/blocks/QuestionBlockCastle.gif",
            "width":16,
            "height":16
          },
          "question_dark":{
            "img":"assets/environment/blocks/QuestionBlockDark.gif",
            "width":16,
            "height":16
          }
        }
      }
    }
    
    // Mario Stage
    var canvas = document.getElementById("mario_game");
    canvas.width = game_config.width;
    canvas.height = game_config.height;
    
    // Basic HTML5 Canvas Functions
    function fillRectWithColor(canvas,x,y,w,h,hex)
    {
      var context = canvas.getContext("2d");
      context.fillStyle = hex;
      context.fillRect(x,y,w,h);
      // will add a stroke around the rectangle
      //strokeRect(x, y, width, height)
      delete context;
    }
    
    fillRectWithColor(canvas,0,0,canvas.width,canvas.height,"#6490FE"); 
    
    // will clear pixels in a specific region
    // clearRect(x, y, width, height)
    
    /*
     Working with Paths
     //Note: Browser can't display true 1px pixels, you need to do x = 1.5,y to x = 1.5,y+3, to get 1 px line 
     var context = canvas.getContext("2d");
     context.moveTo(x,y);
     context.lineTo(x,y);
     context.strokeStyle = "#hex-color";
     context.stroke(); // will fill it in
    */
    function drawPath(a_canvas,x1,y1,x2,y2,stroke_hex,render)
    {
      var context = canvas.getContext("2d");
      context.moveTo(x1,y1);
      context.lineTo(x2,y2);
      context.strokeStyle = stroke_hex;
      context.stroke();
      delete context;
    }
    
    //drawPath(canvas,50,canvas.height,100,50,200,"#000000",true);
    
    // Fonts
    // no box model, can be added at any point
    function placeText(canvas,text,x,y,font)
    {
      var context = canvas.getContext("2d");
      context.font = "bold #000000 12px sans-serif";
      context.fillText("( 0 , 0 )", 8, 5);
      console.log(context.fillText("scott",0,200));
      delete context;
    }
    
    // doesn't seem to work in safari5
    //placeText(canvas,"mario game",50,90,"bold 12px sans-serif");
    
    function buildGradient(canvas)
    {
      var context = canvas.getContext("2d");
      var my_gradient = context.createLinearGradient(0, 0, 0, 225);
      my_gradient.addColorStop(0, "black");
      my_gradient.addColorStop(1, "white");
      context.fillStyle = my_gradient;
      context.fillRect(0, 0, 300, 225);
    }
    //buildGradient(canvas);
    
    //drawImage(image, dx, dy)
    //drawImage(image, dx, dy, dw, dh)
    //drawImage(image, sx, sy, sw, sh, dx, dy, dw, dh)
    function draw(canvas,path_with_image,x,y)
    {
      var context = canvas.getContext("2d");
      var img = new Image();
      img.src = path_with_image;
      img.onload = function()
      {
        context.drawImage(img,x,y);
      }
      delete context;
      delete img;
      console.log(img);
    }
    
    /**
     * Setup a new instance of the Mario Game
    */
    var Mario = (function(){
      // what is the current level?
      var level = 1; // 1,2,3,4,5,6,7,8
      // mario's current lives
      var lives = 3;
      // mario's continues
      var continues = 3;
      // mario's points
      var points = 0;
      // mario's status
      var status = "alive";
      // keeps track of objects within the game
      var elements = new Array();
      // add a new game object
      addElement = function(elem)
      {
        elements.push(elem);
        draw();
      }
      // return a list of active objects
      getElements = function()
      {
        console.log(elements);
        return elements;
      }
      
      // protected methods
      /**
       * Get the Canvas Object
       * @return (Object) canvas The main canvas object
      */
      getCanvas = function()
      {
        return this.canvas;
      }
      
      setCanvas = function(canvas)
      {
        this.canvas = canvas;
      }
      /**
       * Set the Current Level in Mario
       * @param (Integer) level can be 1 to 8
      */
      setLevel = function(level)
      {
        level = level;
      }
      /**
       * Set the Current Available Lives
       * @param (Integer)
      */
      setLives = function(lives)
      {
        lives = lives;
      }
      
      /**
       * Increment Lives
      */
      incrementLives = function()
      {
        lives++;
      }
      
      /**
       * Decrement Lives, or if lives-- <= 0 = gameover
      */
      decrementLives = function()
      {
        if(lives-1 > 0)
        {
          lives--;
        }
        else
        {
          status = "dead";
          endGame();
        }
      }
      /**
       * End Game - Update Canvas to show End Game Screen with continues, or game over
      */
      endGame = function()
      {
        console.log("game over");
      }
      
      draw = function()
      {
        console.log(canvas);
        var objects = getElements();
        for(var i=0; i < objects.length; ++i)
        {
          // draw the objects on the screen
          objects[i].draw(canvas,5,5);
        }
      }
      
      return function()
      {
        this.setCanvas = function(canvas)
        {
          setCanvas(canvas);
        }
        this.getCanvas = function()
        {
          return getCanvas();
        }
        
        this.incrementLives = function()
        {
          incrementLives();
        }
        
        this.decrementLives = function()
        {
          decrementLives();
        }
        
        this.getElements = function()
        {
          this.elements = getElements();
          return this.elements;
        }
        
        this.addElement = function(elem)
        {
          addElement(elem);
        }
        
        this.draw = function()
        {
          console.log("calling private method draw()");
          draw();
        }
      };
    }());
    
    // Element Global
    // Used as foundation for all environment elements
    var Element = (function(){
      var id = 0;
      
      return function()
      {
        this.id = ++id;
        // set position
        this.setPosition = function(x,y)
        {
          this.x = x;
          this.y = y;
        }
        
        // get current x position
        this.getXPos = function()
        {
          return this.x
        }
        this.getYPos = function()
        {
          return this.y;
        }
        // draw the element on the screen
        this.draw = function(canvas,x,y)
        {
          var context = canvas.getContext("2d");
          var img = new Image();
          var xpos = this.getXPos()*16;
          var ypos = this.getYPos()*16;
          img.src = window.environment_db.elements[this.type][this.kind].img;
          img.onload = function()
          {
            context.drawImage(img,xpos,ypos);
          }
          delete context;
          delete img;
          console.log(img);
        }
        
      };
    }());
    Element.prototype.getId = function()
    {
      return this.id;
    }
    Element.prototype.setType = function(type)
    {
      this.type = type;
    }
    Element.prototype.getType = function()
    {
      return this.type;
    }
    Element.prototype.setKind = function(kind)
    {
      this.kind = kind;
    }
    console.log(canvas);
    //function(canvas,level,lives,continues)
    var game = new Mario(this.canvas,1,3,3);
    // set drawing surface
    game.setCanvas(canvas);
    /*
     Build a single block
    */
    var elem = new Element();
    elem.setType("block");
    elem.setKind("brick_brown");
    elem.setPosition(10,11);
    //console.log(elem.getId());
    
    //add a block
    game.addElement(elem);
    
    /*
      add the first ground section to level 1
      69 blocks across by 2 high
    */
    var gstart_x = 0;
    var gstart_y = 17;
    for(var j=0;j<20;++j)
    {
      // can share an instance of image, rather than having one image per block
      this["ground"+j] = new Element();
      this["ground"+j].setType("block");
      this["ground"+j].setKind("ground_brown");
      this["ground"+j].setPosition(gstart_x,gstart_y);
      game.addElement(this["ground"+j]);
      gstart_x += 1;
    }
    
    // force a refresh of the screen
    game.draw();
    
  </script>
</html>
  